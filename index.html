<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediChat - Medication Assistant</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="MediChat: Your personal medication and health assistant">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712109.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            width: 350px;
            height: 650px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9f9f9;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
            clear: both;
            padding: 10px;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            line-height: 1.4;
        }

        .bot-message {
            background-color: #e6f2ff;
            float: left;
        }

        .user-message {
            background-color: #dcf8c6;
            float: right;
            text-align: right;
            justify-content: flex-end;
        }

        .bot-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }

        .message-content {
            flex-grow: 1;
            font-size: 0.95em;
        }

        .input-container {
            display: flex;
            padding: 10px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }

        #userInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            font-size: 0.9em;
        }

        #sendButton {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        #sendButton:hover {
            background-color: #388E3C;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 5px;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.9em;
        }

        .option-button:hover {
            background-color: #e0e0e0;
        }

        #notificationArea {
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 1000;
        }

        .notification {
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .api-result {
            background-color: #ffffff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 10px;
            font-size: 0.9em;
        }

        .api-result strong {
            color: #4CAF50;
        }

        .api-result ul {
            margin: 5px 0 0 20px;
            padding: 0;
        }

        .api-result li {
            margin-bottom: 5px;
        }

        .bold-number {
            font-weight: bold;
            color: #388E3C;
        }
    </style>
</head>
<body>
    <div id="notificationArea"></div>
    <div class="app-container">
        <div class="chat-header">MediChat</div>
        <div id="chatContainer" class="chat-container"></div>
        <div class="input-container">
            <input type="text" id="userInput" placeholder="Type your message...">
            <button id="sendButton">Send</button>
        </div>
    </div>

    <audio id="notificationSound">
        <source src="https://www.soundjay.com/buttons/sounds/button-1.mp3" type="audio/mpeg">
        <source src="https://www.w3schools.com/html/horse.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
    class MediChatAssistant {
        constructor() {
            this._storage = {
                medications: [],
                history: [],
                notificationQueue: [],
                drugCache: {},
                shownFacilities: {},
                shownLabs: {}
            };

            this.drugDatabase = {
                'aspirin': {
                    purpose: 'Pain relief, fever reduction, and anti-inflammatory',
                    uses: ['Treat mild to moderate pain', 'Reduce fever', 'Help prevent heart attacks and strokes'],
                    warnings: ['Do not give to children or teenagers with viral infections', 'May cause stomach bleeding']
                },
                'ibuprofen': {
                    purpose: 'Pain relief and anti-inflammatory',
                    uses: ['Reduce fever', 'Treat mild to moderate pain', 'Relieve menstrual cramps'],
                    warnings: ['May increase risk of heart attack or stroke', 'Can cause stomach ulcers']
                }
            };

            this.chatContainer = document.getElementById('chatContainer');
            this.userInput = document.getElementById('userInput');
            this.sendButton = document.getElementById('sendButton');
            this.notificationArea = document.getElementById('notificationArea');
            this.notificationSound = document.getElementById('notificationSound');

            this.currentStep = null;
            this.currentMedication = null;
            this.currentTimeIndex = 0;
            this.editingIndex = null;

            this.notificationInterval = null;
            this.isSoundEnabled = false;

            this.geminiApiKey = 'AIzaSyDjWCg92bv-kn6U2ArSxBSGw1wpi3SdstA';

            this.setupEventListeners();
            this.loadMedications();
            this.initializeApp();
            this.registerServiceWorker();
        }

        registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    }).catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
                });
            }
        }

        setupEventListeners() {
            this.sendButton.addEventListener('click', () => {
                this.handleUserInput();
                this.enableSound();
            });
            this.userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    this.handleUserInput();
                    this.enableSound();
                }
            });
        }

        enableSound() {
            this.isSoundEnabled = true;
        }

        loadMedications() {
            const savedMeds = localStorage.getItem('mediChatMedications');
            if (savedMeds) {
                this._storage.medications = JSON.parse(savedMeds);
            }
        }

        saveMedications() {
            localStorage.setItem('mediChatMedications', JSON.stringify(this._storage.medications));
        }

        initializeApp() {
            this.startNotificationSystem();
            this.startConversation();
        }

        startNotificationSystem() {
            if (this.notificationInterval) {
                clearInterval(this.notificationInterval);
            }

            this.notificationInterval = setInterval(() => {
                this.generateNotifications();
            }, 10000);
        }

        generateNotifications() {
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                              now.getMinutes().toString().padStart(2, '0');
            
            this._storage.medications.forEach(med => {
                if (med.notify) {
                    const shouldNotify = this.checkMedicationFrequency(med, now);
                    if (shouldNotify) {
                        let timesToCheck = med.frequency === 'Twice Daily' ? med.times : [med.time];
                        timesToCheck.forEach(time => {
                            if (time && time === currentTime) {
                                const notificationKey = `${med.name}_${time}_${now.toDateString()}`;
                                const existingNotification = this._storage.notificationQueue.find(n => n.key === notificationKey);
                                if (!existingNotification) {
                                    const notification = this.createNotification(
                                        `Time to take ${med.name} (${med.frequency})`
                                    );
                                    this._storage.notificationQueue.push({
                                        key: notificationKey,
                                        timestamp: now.toISOString()
                                    });
                                }
                            }
                        });
                    }
                }
            });

            this._storage.notificationQueue = this._storage.notificationQueue.filter(
                n => (now.getTime() - new Date(n.timestamp).getTime()) < 24 * 60 * 60 * 1000
            );
        }

        checkMedicationFrequency(medication, currentDate) {
            switch(medication.frequency) {
                case 'Once Daily':
                    return true;
                case 'Twice Daily':
                    return true;
                case 'Weekly':
                    return currentDate.getDay() === medication.weekDay;
                default:
                    return true;
            }
        }

        createNotification(message) {
            const notificationElement = document.createElement('div');
            notificationElement.classList.add('notification');
            notificationElement.textContent = message;
            
            this.notificationArea.appendChild(notificationElement);

            if (this.isSoundEnabled) {
                this.playNotificationSound();
            }

            setTimeout(() => {
                this.notificationArea.removeChild(notificationElement);
            }, 30000);

            return notificationElement;
        }

        playNotificationSound() {
            const audio = this.notificationSound;
            audio.currentTime = 0;
            if (this.isSoundEnabled) {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {})
                        .catch(error => {
                            if (audio.src !== 'https://www.w3schools.com/html/horse.mp3') {
                                audio.src = 'https://www.w3schools.com/html/horse.mp3';
                                audio.play().catch(e => console.warn('Fallback sound failed:', e));
                            }
                        });
                }
            }
        }

        startConversation() {
            this.addMessage('Hello there! 👋 Welcome to MediChat, your friendly health assistant! How can I assist you today? 🌟');
            this.showOptions([
                'Add Medication',
                'View Medications',
                'Check Drug Info',
                'Find Medical Stores',
                'Find Testing Labs',
                'Insurance Information',
                'Lab Result Interpretation',
                'Symptom Checker',
                'Health Tips'
            ]);
        }

        async callGeminiApi(prompt) {
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + this.geminiApiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'MediChat/1.0'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`Gemini API error: ${response.status}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('Gemini API call failed:', error);
                return 'Sorry, I couldn’t process your request right now. Please try again later.';
            }
        }

        handleUserInput() {
            const input = this.userInput.value.trim();
            if (!input) return;

            this.addMessage(input, 'user');
            this.userInput.value = '';

            switch(this.currentStep) {
                case 'medicationName':
                    this.handleMedicationName(input);
                    break;
                case 'medicationTime':
                    this.handleMedicationTime(input);
                    break;
                case 'medicationNotify':
                    this.handleMedicationNotify(input);
                    break;
                case 'drugInfoRequest':
                    this.fetchDrugInformation(input);
                    break;
                case 'locationSearchCity':
                    this.findMedicalStoresByCity(input);
                    break;
                case 'locationSearchPincode':
                    this.findMedicalStoresByPincode(input);
                    break;
                case 'labSearchCity':
                    this.findTestingLabsByCity(input);
                    break;
                case 'labSearchPincode':
                    this.findTestingLabsByPincode(input);
                    break;
                case 'editMedication':
                    this.startEditMedicationFlow(input);
                    break;
                case 'deleteMedication':
                    this.deleteMedication(parseInt(input) - 1);
                    break;
                case 'editMedicationName':
                    this.handleEditMedicationName(input);
                    break;
                case 'editMedicationTime':
                    this.handleEditMedicationTime(input);
                    break;
                case 'editMedicationNotify':
                    this.handleEditMedicationNotify(input);
                    break;
                case 'insuranceInfo':
                    this.handleInsuranceInfo(input);
                    break;
                case 'labResultInterpretation':
                    this.handleLabResultInterpretation(input);
                    break;
                case 'symptomChecker':
                    this.handleSymptomChecker(input);
                    break;
                default:
                    if (input.toLowerCase() === 'hi' || input.toLowerCase() === 'hello') {
                        this.startConversation();
                    } else {
                        this.addMessage('Please select an option from the menu below! 😊');
                        this.startConversation();
                    }
                    break;
            }
        }

        addMessage(message, type = 'bot') {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(`${type}-message`);
            
            if (type === 'bot') {
                const avatar = document.createElement('img');
                avatar.src = 'https://cdn-icons-png.flaticon.com/512/4712/4712109.png';
                avatar.classList.add('bot-avatar');
                avatar.alt = 'MediChat Bot';
                messageElement.appendChild(avatar);
            }
            
            const content = document.createElement('div');
            content.classList.add('message-content');
            content.innerHTML = message;
            messageElement.appendChild(content);
            
            this.chatContainer.appendChild(messageElement);
            this.chatContainer.scrollTop = this.chatContainer.scrollHeight;

            this._storage.history.push({
                type,
                message,
                timestamp: new Date().toISOString()
            });
        }

        showOptions(options) {
            const existingButtons = this.chatContainer.querySelectorAll('.option-button');
            existingButtons.forEach(btn => btn.remove());

            options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-button');
                button.addEventListener('click', () => this.handleOptionSelect(option));
                this.chatContainer.appendChild(button);
            });
        }

        handleOptionSelect(option) {
            const existingButtons = this.chatContainer.querySelectorAll('.option-button');
            existingButtons.forEach(btn => btn.remove());

            this.addMessage(option, 'user');

            switch(option) {
                case 'Add Medication':
                    this.startMedicationFlow();
                    break;
                case 'View Medications':
                    this.viewMedications();
                    break;
                case 'Check Drug Info':
                    this.addMessage('Enter the name of the medication:');
                    this.currentStep = 'drugInfoRequest';
                    break;
                case 'Find Medical Stores':
                    this.findMedicalStores();
                    break;
                case 'Find Testing Labs':
                    this.findTestingLabs();
                    break;
                case 'Insurance Information':
                    this.addMessage('Please describe your insurance query (e.g., coverage details, claim process):');
                    this.currentStep = 'insuranceInfo';
                    break;
                case 'Lab Result Interpretation':
                    this.addMessage('Please enter your lab result details (e.g., "High cholesterol 240 mg/dL"):');
                    this.currentStep = 'labResultInterpretation';
                    break;
                case 'Symptom Checker':
                    this.addMessage('Please list your symptoms (e.g., "fever, cough, headache"):');
                    this.currentStep = 'symptomChecker';
                    break;
                case 'Health Tips':
                    this.generateHealthTips();
                    break;
                case 'Edit Medication':
                    this.viewMedicationsForEdit();
                    this.addMessage('Enter the number of the medication to edit (e.g., 1):');
                    this.currentStep = 'editMedication';
                    break;
                case 'Delete Medication':
                    this.viewMedicationsForDelete();
                    this.addMessage('Enter the number of the medication to delete (e.g., 1):');
                    this.currentStep = 'deleteMedication';
                    break;
                case 'Back to Main Menu':
                    this.currentStep = null;
                    this.editingIndex = null;
                    this.startConversation();
                    break;
                case 'Add Another Medication':
                    this.startMedicationFlow();
                    break;
                case 'Search by City':
                    this.addMessage('Enter the city name (e.g., "Hyderabad"):');
                    this.currentStep = 'locationSearchCity';
                    break;
                case 'Search by Pincode':
                    this.addMessage('Enter the pincode (e.g., "500001"):');
                    this.currentStep = 'locationSearchPincode';
                    break;
                case 'Search Another City':
                    this.addMessage('Enter the city name (e.g., "Hyderabad"):');
                    this.currentStep = 'locationSearchCity';
                    break;
                case 'Search Another Pincode':
                    this.addMessage('Enter the pincode (e.g., "500001"):');
                    this.currentStep = 'locationSearchPincode';
                    break;
                case 'Search Labs by City':
                    this.addMessage('Enter the city name (e.g., "Hyderabad"):');
                    this.currentStep = 'labSearchCity';
                    break;
                case 'Search Labs by Pincode':
                    this.addMessage('Enter the pincode (e.g., "500001"):');
                    this.currentStep = 'labSearchPincode';
                    break;
                case 'Search Another Lab City':
                    this.addMessage('Enter the city name (e.g., "Hyderabad"):');
                    this.currentStep = 'labSearchCity';
                    break;
                case 'Search Another Lab Pincode':
                    this.addMessage('Enter the pincode (e.g., "500001"):');
                    this.currentStep = 'labSearchPincode';
                    break;
                case 'Check Another Drug':
                    this.addMessage('Enter the name of the medication:');
                    this.currentStep = 'drugInfoRequest';
                    break;
                case 'Ask Another Insurance Question':
                    this.addMessage('Please describe your insurance query:');
                    this.currentStep = 'insuranceInfo';
                    break;
                case 'Interpret Another Lab Result':
                    this.addMessage('Please enter your lab result details:');
                    this.currentStep = 'labResultInterpretation';
                    break;
                case 'Check Another Symptom':
                    this.addMessage('Please list your symptoms:');
                    this.currentStep = 'symptomChecker';
                    break;
                case 'Once Daily':
                case 'Twice Daily':
                case 'Weekly':
                    if (this.currentStep === 'medicationFrequency' || this.currentStep === 'editMedicationFrequency') {
                        this.handleMedicationFrequency(option);
                    }
                    break;
                case 'Monday':
                case 'Tuesday':
                case 'Wednesday':
                case 'Thursday':
                case 'Friday':
                case 'Saturday':
                case 'Sunday':
                    if (this.currentStep === 'medicationWeekDay' || this.currentStep === 'editMedicationWeekDay') {
                        this.handleMedicationWeekDay(option);
                    }
                    break;
                case 'Yes':
                case 'No':
                    if (this.currentStep === 'medicationNotify' || this.currentStep === 'editMedicationNotify') {
                        this.handleMedicationNotify(option);
                    }
                    break;
            }
        }

        async handleInsuranceInfo(query) {
            const prompt = `You are a health insurance assistant. Provide clear, accurate, and concise information for the following insurance-related query: "${query}". If the query is about coverage, claims, or policy details, explain in simple terms and include general steps or considerations. Do not provide specific policy numbers or personal data.`;
            const response = await this.callGeminiApi(prompt);
            
            const infoHTML = `
                <div class="api-result">
                    <strong>Insurance Information:</strong><br><br>
                    ${response.replace(/\n/g, '<br>')}
                </div>
            `;
            this.addMessage(infoHTML);
            this.showOptions(['Ask Another Insurance Question', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async handleLabResultInterpretation(result) {
            const prompt = `You are a medical assistant. Interpret the following lab result in simple, patient-friendly language: "${result}". Explain what the result means, whether it's within normal range, and any potential implications. Include a disclaimer that this is for informational purposes and not a substitute for professional medical advice.`;
            const response = await this.callGeminiApi(prompt);
            
            const infoHTML = `
                <div class="api-result">
                    <strong>Lab Result Interpretation:</strong><br><br>
                    ${response.replace(/\n/g, '<br>')}<br><br>
                    <small>Disclaimer: This information is for educational purposes only. Consult your healthcare provider for professional advice.</small>
                </div>
            `;
            this.addMessage(infoHTML);
            this.showOptions(['Interpret Another Lab Result', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async handleSymptomChecker(symptoms) {
            const prompt = `You are a medical symptom checker. Based on the following symptoms: "${symptoms}", suggest possible conditions in simple language. Provide a brief explanation of each condition and recommend consulting a healthcare professional. Include a disclaimer that this is not a diagnosis.`;
            const response = await this.callGeminiApi(prompt);
            
            const infoHTML = `
                <div class="api-result">
                    <strong>Symptom Checker Results:</strong><br><br>
                    ${response.replace(/\n/g, '<br>')}<br><br>
                    <small>Disclaimer: This is not a medical diagnosis. Please consult a healthcare provider for accurate assessment.</small>
                </div>
            `;
            this.addMessage(infoHTML);
            this.showOptions(['Check Another Symptom', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async generateHealthTips() {
            const prompt = `You are a health assistant. Generate 3 personalized, actionable health tips for daily wellness. Keep each tip concise, practical, and suitable for a general audience. Format as a numbered list.`;
            const response = await this.callGeminiApi(prompt);
            
            const infoHTML = `
                <div class="api-result">
                    <strong>Daily Health Tips:</strong><br><br>
                    ${response.replace(/\n/g, '<br>')}
                </div>
            `;
            this.addMessage(infoHTML);
            this.showOptions(['Health Tips', 'Back to Main Menu']);
        }

        findMedicalStores() {
            this.addMessage('How would you like to search for medical stores?');
            this.showOptions(['Search by City', 'Search by Pincode']);
        }

        findTestingLabs() {
            this.addMessage('How would you like to search for testing labs?');
            this.showOptions(['Search Labs by City', 'Search Labs by Pincode']);
        }

        getReadableAddress(tags) {
            const parts = [];
            if (tags['addr:housenumber']) parts.push(tags['addr:housenumber']);
            if (tags['addr:street']) parts.push(tags['addr:street']);
            if (tags['addr:city']) parts.push(tags['addr:city']);
            if (tags['addr:state']) parts.push(tags['addr:state']);
            if (tags['addr:postcode']) parts.push(tags['addr:postcode']);
            if (tags['addr:country']) parts.push(tags['addr:country']);
            return parts.length > 0 ? parts.join(', ') : 'Address not fully specified';
        }

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async findMedicalStoresByCity(cityName) {
            if (!cityName || !isNaN(cityName)) {
                this.addMessage('Please enter a valid city name (e.g., "Hyderabad").');
                this.showOptions(['Search Another City', 'Search Another Pincode', 'Back to Main Menu']);
                return;
            }

            this.addMessage(`Searching for medical facilities in ${cityName}...`);

            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`;
                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!nominatimResponse.ok) {
                    throw new Error(`Nominatim API failed: ${nominatimResponse.status}`);
                }

                const nominatimData = await nominatimResponse.json();
                if (!nominatimData || nominatimData.length === 0) {
                    throw new Error(`City "${cityName}" not found`);
                }

                const { lat, lon } = nominatimData[0];

                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="pharmacy"](around:10000,${lat},${lon});
                        node["amenity"="hospital"](around:10000,${lat},${lon});
                    );
                    out body;
                `;

                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'MediChat/1.0'
                    },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });

                if (!overpassResponse.ok) {
                    throw new Error(`Overpass API failed: ${overpassResponse.status}`);
                }

                const data = await overpassResponse.json();

                if (data.elements && data.elements.length > 0) {
                    let pharmacies = data.elements.filter(e => e.tags && e.tags.amenity === 'pharmacy');
                    let hospitals = data.elements.filter(e => e.tags && e.tags.amenity === 'hospital');

                    const cityKey = `${cityName.toLowerCase()}_${Date.now()}`;
                    if (!this._storage.shownFacilities[cityKey]) {
                        this._storage.shownFacilities[cityKey] = { pharmacies: [], hospitals: [] };
                    }

                    const shownPharmacyIds = this._storage.shownFacilities[cityKey].pharmacies;
                    const shownHospitalIds = this._storage.shownFacilities[cityKey].hospitals;

                    pharmacies = pharmacies.filter(p => !shownPharmacyIds.includes(p.id));
                    hospitals = hospitals.filter(h => !shownHospitalIds.includes(h.id));

                    if (pharmacies.length === 0 && hospitals.length === 0) {
                        this.addMessage(`No new medical facilities found in ${cityName}. All available options have been shown.`);
                    } else {
                        pharmacies = this.shuffleArray(pharmacies);
                        hospitals = this.shuffleArray(hospitals);

                        const selectedPharmacies = pharmacies.slice(0, Math.min(5, pharmacies.length));
                        const selectedHospitals = hospitals.slice(0, Math.min(5, hospitals.length));

                        selectedPharmacies.forEach(p => shownPharmacyIds.push(p.id));
                        selectedHospitals.forEach(h => shownHospitalIds.push(h.id));

                        let resultHTML = `<div class="api-result"><strong>Medical Facilities in ${cityName}:</strong><br><br>`;

                        resultHTML += `<strong>Pharmacies:</strong><br>`;
                        if (selectedPharmacies.length > 0) {
                            selectedPharmacies.forEach((pharmacy, index) => {
                                const name = pharmacy.tags.name || `Pharmacy ${index + 1}`;
                                const address = this.getReadableAddress(pharmacy.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new pharmacies available in this search.<br>';
                        }

                        resultHTML += `<br><strong>Hospitals:</strong><br>`;
                        if (selectedHospitals.length > 0) {
                            selectedHospitals.forEach((hospital, index) => {
                                const name = hospital.tags.name || `Hospital ${index + 1}`;
                                const address = this.getReadableAddress(hospital.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new hospitals available in this search.<br>';
                        }

                        resultHTML += '</div>';
                        this.addMessage(resultHTML);
                    }
                } else {
                    this.addMessage(`No medical facilities found in ${cityName}.`);
                }
           
            } catch (error) {
                let errorMessage = `Could not find medical facilities in ${cityName}. `;
                if (error.message.includes('Nominatim API failed')) {
                    errorMessage += `City lookup failed (${error.message.split(':')[1].trim()}). Please check the city name.`;
                } else if (error.message.includes('Overpass API failed')) {
                    errorMessage += `Service unavailable (${error.message.split(':')[1].trim()}). Please try again later.`;
                } else if (error.message.includes('not found')) {
                    errorMessage += `City not recognized. Please try a different city.`;
                } else {
                    errorMessage += 'An unexpected error occurred. Please try again.';
                }
                this.addMessage(errorMessage);
            }

            this.showOptions(['Search Another City', 'Search Another Pincode', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async findMedicalStoresByPincode(pincode) {
            if (!pincode || !/^\d{6}$/.test(pincode)) {
                this.addMessage('Please enter a valid 6-digit Indian pincode (e.g., "500001").');
                this.showOptions(['Search Another City', 'Search Another Pincode', 'Back to Main Menu']);
                return;
            }

            this.addMessage(`Searching for medical facilities near pincode ${pincode}...`);

            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?country=India&postalcode=${encodeURIComponent(pincode)}&format=json&limit=1`;
                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!nominatimResponse.ok) {
                    throw new Error(`Nominatim API failed: ${nominatimResponse.status}`);
                }

                const nominatimData = await nominatimResponse.json();
                if (!nominatimData || nominatimData.length === 0) {
                    throw new Error(`Pincode "${pincode}" not found in India`);
                }

                const { lat, lon } = nominatimData[0];

                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="pharmacy"](around:10000,${lat},${lon});
                        node["amenity"="hospital"](around:10000,${lat},${lon});
                    );
                    out body;
                `;

                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'MediChat/1.0'
                    },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });

                if (!overpassResponse.ok) {
                    throw new Error(`Overpass API failed: ${overpassResponse.status}`);
                }

                const data = await overpassResponse.json();

                if (data.elements && data.elements.length > 0) {
                    let pharmacies = data.elements.filter(e => e.tags && e.tags.amenity === 'pharmacy');
                    let hospitals = data.elements.filter(e => e.tags && e.tags.amenity === 'hospital');

                    const pincodeKey = `${pincode}_${Date.now()}`;
                    if (!this._storage.shownFacilities[pincodeKey]) {
                        this._storage.shownFacilities[pincodeKey] = { pharmacies: [], hospitals: [] };
                    }

                    const shownPharmacyIds = this._storage.shownFacilities[pincodeKey].pharmacies;
                    const shownHospitalIds = this._storage.shownFacilities[pincodeKey].hospitals;

                    pharmacies = pharmacies.filter(p => !shownPharmacyIds.includes(p.id));
                    hospitals = hospitals.filter(h => !shownHospitalIds.includes(h.id));

                    if (pharmacies.length === 0 && hospitals.length === 0) {
                        this.addMessage(`No new medical facilities found near ${pincode}. All available options have been shown.`);
                    } else {
                        pharmacies = this.shuffleArray(pharmacies);
                        hospitals = this.shuffleArray(hospitals);

                        const selectedPharmacies = pharmacies.slice(0, Math.min(5, pharmacies.length));
                        const selectedHospitals = hospitals.slice(0, Math.min(5, hospitals.length));

                        selectedPharmacies.forEach(p => shownPharmacyIds.push(p.id));
                        selectedHospitals.forEach(h => shownHospitalIds.push(h.id));

                        let resultHTML = `<div class="api-result"><strong>Medical Facilities near ${pincode}:</strong><br><br>`;

                        resultHTML += `<strong>Pharmacies:</strong><br>`;
                        if (selectedPharmacies.length > 0) {
                            selectedPharmacies.forEach((pharmacy, index) => {
                                const name = pharmacy.tags.name || `Pharmacy ${index + 1}`;
                                const address = this.getReadableAddress(pharmacy.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new pharmacies available in this search.<br>';
                        }

                        resultHTML += `<br><strong>Hospitals:</strong><br>`;
                        if (selectedHospitals.length > 0) {
                            selectedHospitals.forEach((hospital, index) => {
                                const name = hospital.tags.name || `Hospital ${index + 1}`;
                                const address = this.getReadableAddress(hospital.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new hospitals available in this search.<br>';
                        }

                        resultHTML += '</div>';
                        this.addMessage(resultHTML);
                    }
                } else {
                    this.addMessage(`No medical facilities found near ${pincode}.`);
                }
            } catch (error) {
                let errorMessage = `Could not find medical facilities near ${pincode}. `;
                if (error.message.includes('Nominatim API failed')) {
                    errorMessage += `Pincode lookup failed (${error.message.split(':')[1].trim()}). Please check the pincode.`;
                } else if (error.message.includes('Overpass API failed')) {
                    errorMessage += `Service unavailable (${error.message.split(':')[1].trim()}). Please try again later.`;
                } else if (error.message.includes('not found')) {
                    errorMessage += `Pincode not recognized in India. Please try a different pincode.`;
                } else {
                    errorMessage += 'An unexpected error occurred. Please try again.';
                }
                this.addMessage(errorMessage);
            }

            this.showOptions(['Search Another City', 'Search Another Pincode', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async findTestingLabsByCity(cityName) {
            if (!cityName || !isNaN(cityName)) {
                this.addMessage('Please enter a valid city name (e.g., "Hyderabad").');
                this.showOptions(['Search Another Lab City', 'Search Another Lab Pincode', 'Back to Main Menu']);
                return;
            }

            this.addMessage(`Searching for testing labs in ${cityName}...`);

            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`;
                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!nominatimResponse.ok) {
                    throw new Error(`Nominatim API failed: ${nominatimResponse.status}`);
                }

                const nominatimData = await nominatimResponse.json();
                if (!nominatimData || nominatimData.length === 0) {
                    throw new Error(`City "${cityName}" not found`);
                }

                const { lat, lon } = nominatimData[0];

                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="clinic"]["healthcare:speciality"~"laboratory|diagnostic"](around:10000,${lat},${lon});
                        node["healthcare"="laboratory"](around:10000,${lat},${lon});
                    );
                    out body;
                `;

                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'MediChat/1.0'
                    },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });

                if (!overpassResponse.ok) {
                    throw new Error(`Overpass API failed: ${overpassResponse.status}`);
                }

                const data = await overpassResponse.json();

                if (data.elements && data.elements.length > 0) {
                    let labs = data.elements.filter(e => 
                        (e.tags["amenity"] === "clinic" && e.tags["healthcare:speciality"]?.match(/laboratory|diagnostic/)) || 
                        e.tags["healthcare"] === "laboratory"
                    );

                    const cityKey = `${cityName.toLowerCase()}_${Date.now()}`;
                    if (!this._storage.shownLabs[cityKey]) {
                        this._storage.shownLabs[cityKey] = [];
                    }

                    const shownLabIds = this._storage.shownLabs[cityKey];
                    labs = labs.filter(l => !shownLabIds.includes(l.id));

                    if (labs.length === 0) {
                        this.addMessage(`No new testing labs found in ${cityName}. All available options have been shown.`);
                    } else {
                        labs = this.shuffleArray(labs);

                        const selectedLabs = labs.slice(0, Math.min(5, labs.length));

                        selectedLabs.forEach(l => shownLabIds.push(l.id));

                        let resultHTML = `<div class="api-result"><strong>Testing Labs in ${cityName}:</strong><br><br>`;

                        resultHTML += `<strong>Diagnostic Labs:</strong><br>`;
                        if (selectedLabs.length > 0) {
                            selectedLabs.forEach((lab, index) => {
                                const name = lab.tags.name || `Lab ${index + 1}`;
                                const address = this.getReadableAddress(lab.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new testing labs available in this search.<br>';
                        }

                        resultHTML += '</div>';
                        this.addMessage(resultHTML);
                    }
                } else {
                    this.addMessage(`No testing labs found in ${cityName}.`);
                }
            } catch (error) {
                let errorMessage = `Could not find testing labs in ${cityName}. `;
                if (error.message.includes('Nominatim API failed')) {
                    errorMessage += `City lookup failed (${error.message.split(':')[1].trim()}). Please check the city name.`;
                } else if (error.message.includes('Overpass API failed')) {
                    errorMessage += `Service unavailable (${error.message.split(':')[1].trim()}). Please try again later.`;
                } else if (error.message.includes('not found')) {
                    errorMessage += `City not recognized. Please try a different city.`;
                } else {
                    errorMessage += 'An unexpected error occurred. Please try again.';
                }
                this.addMessage(errorMessage);
            }

            this.showOptions(['Search Another Lab City', 'Search Another Lab Pincode', 'Back to Main Menu']);
            this.currentStep = null;
        }

        async findTestingLabsByPincode(pincode) {
            if (!pincode || !/^\d{6}$/.test(pincode)) {
                this.addMessage('Please enter a valid 6-digit Indian pincode (e.g., "500001").');
                this.showOptions(['Search Another Lab City', 'Search Another Lab Pincode', 'Back to Main Menu']);
                return;
            }

            this.addMessage(`Searching for testing labs near pincode ${pincode}...`);

            try {
                const nominatimUrl = `https://nominatim.openstreetmap.org/search?country=India&postalcode=${encodeURIComponent(pincode)}&format=json&limit=1`;
                const nominatimResponse = await fetch(nominatimUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!nominatimResponse.ok) {
                    throw new Error(`Nominatim API failed: ${nominatimResponse.status}`);
                }

                const nominatimData = await nominatimResponse.json();
                if (!nominatimData || nominatimData.length === 0) {
                    throw new Error(`Pincode "${pincode}" not found in India`);
                }

                const { lat, lon } = nominatimData[0];

                const overpassQuery = `
                    [out:json][timeout:25];
                    (
                        node["amenity"="clinic"]["healthcare:speciality"~"laboratory|diagnostic"](around:10000,${lat},${lon});
                        node["healthcare"="laboratory"](around:10000,${lat},${lon});
                    );
                    out body;
                `;

                const overpassResponse = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'MediChat/1.0'
                    },
                    body: `data=${encodeURIComponent(overpassQuery)}`
                });

                if (!overpassResponse.ok) {
                    throw new Error(`Overpass API failed: ${overpassResponse.status}`);
                }

                const data = await overpassResponse.json();

                if (data.elements && data.elements.length > 0) {
                    let labs = data.elements.filter(e => 
                        (e.tags["amenity"] === "clinic" && e.tags["healthcare:speciality"]?.match(/laboratory|diagnostic/)) || 
                        e.tags["healthcare"] === "laboratory"
                    );

                    const pincodeKey = `${pincode}_${Date.now()}`;
                    if (!this._storage.shownLabs[pincodeKey]) {
                        this._storage.shownLabs[pincodeKey] = [];
                    }

                    const shownLabIds = this._storage.shownLabs[pincodeKey];
                    labs = labs.filter(l => !shownLabIds.includes(l.id));

                    if (labs.length === 0) {
                        this.addMessage(`No new testing labs found near ${pincode}. All available options have been shown.`);
                    } else {
                        labs = this.shuffleArray(labs);

                        const selectedLabs = labs.slice(0, Math.min(5, labs.length));

                        selectedLabs.forEach(l => shownLabIds.push(l.id));

                        let resultHTML = `<div class="api-result"><strong>Testing Labs near ${pincode}:</strong><br><br>`;

                        resultHTML += `<strong>Diagnostic Labs:</strong><br>`;
                        if (selectedLabs.length > 0) {
                            selectedLabs.forEach((lab, index) => {
                                const name = lab.tags.name || `Lab ${index + 1}`;
                                const address = this.getReadableAddress(lab.tags);
                                resultHTML += `<span class="bold-number">${index + 1}.</span> ${name} - ${address}<br>`;
                            });
                        } else {
                            resultHTML += 'No new testing labs available in this search.<br>';
                        }

                        resultHTML += '</div>';
                        this.addMessage(resultHTML);
                    }
                } else {
                    this.addMessage(`No testing labs found near ${pincode}.`);
                }
            } catch (error) {
                let errorMessage = `Could not find testing labs near ${pincode}. `;
                if (error.message.includes('Nominatim API failed')) {
                    errorMessage += `Pincode lookup failed (${error.message.split(':')[1].trim()}). Please check the pincode.`;
                } else if (error.message.includes('Overpass API failed')) {
                    errorMessage += `Service unavailable (${error.message.split(':')[1].trim()}). Please try again later.`;
                } else if (error.message.includes('not found')) {
                    errorMessage += `Pincode not recognized in India. Please try a different pincode.`;
                } else {
                    errorMessage += 'An unexpected error occurred. Please try again.';
                }
                this.addMessage(errorMessage);
            }

            this.showOptions(['Search Another Lab City', 'Search Another Lab Pincode', 'Back to Main Menu']);
            this.currentStep = null;
        }

        startMedicationFlow() {
            this.addMessage('Let\'s add a new medication! What’s the name of the medication?');
            this.currentStep = 'medicationName';
        }

        handleMedicationName(name) {
            if (!name || /^\d+$/.test(name)) {
                this.addMessage('Please enter a valid medication name.');
                return;
            }

            if ((name.toLowerCase() === 'aspirin' && this._storage.medications.some(m => m.name.toLowerCase() === 'ibuprofen')) ||
                (name.toLowerCase() === 'ibuprofen' && this._storage.medications.some(m => m.name.toLowerCase() === 'aspirin'))) {
                this.addMessage('⚠️ Warning: Combining Aspirin and Ibuprofen may increase bleeding risk. Consult your doctor.');
            }

            this.currentMedication = { name: name };
            this.addMessage('How often do you want to take this medication?');
            this.showOptions(['Once Daily', 'Twice Daily', 'Weekly']);
            this.currentStep = 'medicationFrequency';
        }

        handleMedicationFrequency(frequency) {
            this.currentMedication.frequency = frequency;
            this.currentMedication.times = [];
            
            if (frequency === 'Weekly') {
                this.addMessage('Which day of the week would you like to take it?');
                this.showOptions(['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']);
                this.currentStep = this.editingIndex !== null ? 'editMedicationWeekDay' : 'medicationWeekDay';
            } else {
                this.currentTimeIndex = 0;
                const timePrompt = frequency === 'Twice Daily' 
                    ? 'At what time do you want to take this in the morning? (HH:MM format)'
                    : 'At what time do you want to take this? (HH:MM format)';
                this.addMessage(timePrompt);
                this.currentStep = this.editingIndex !== null ? 'editMedicationTime' : 'medicationTime';
            }
        }

        handleMedicationWeekDay(day) {
            const dayMap = {
                'Sunday': 0, 'Monday': 1, 'Tuesday': 2, 'Wednesday': 3, 
                'Thursday': 4, 'Friday': 5, 'Saturday': 6
            };

            this.currentMedication.weekDay = dayMap[day];
            this.addMessage('At what time do you want to take this medication? (HH:MM format)');
            this.currentStep = this.editingIndex !== null ? 'editMedicationTime' : 'medicationTime';
        }

        handleMedicationTime(time) {
            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeRegex.test(time)) {
                this.addMessage('Please enter a valid time in HH:MM format (e.g., 14:30).');
                return;
            }

            if (this.currentMedication.frequency === 'Twice Daily') {
                this.currentMedication.times = this.currentMedication.times || [];
                this.currentMedication.times.push(time);

                if (this.currentTimeIndex === 0) {
                    this.currentTimeIndex++;
                    this.addMessage('At what time do you want to take this in the evening? (HH:MM format)');
                    return;
                }
            } else {
                this.currentMedication.time = time;
            }

            this.addMessage('Would you like notifications for this medication?');
            this.showOptions(['Yes', 'No']);
            this.currentStep = this.editingIndex !== null ? 'editMedicationNotify' : 'medicationNotify';
        }

        handleMedicationNotify(choice) {
            this.currentMedication.notify = choice === 'Yes';

            if (this.editingIndex !== null) {
                this._storage.medications[this.editingIndex] = this.currentMedication;
                this.addMessage(`Medication ${this.currentMedication.name} updated successfully! 🎉`);
                this.saveMedications();
                this.editingIndex = null;
            } else {
                this.addMedication(this.currentMedication);
                let frequencyText = this.currentMedication.frequency;
                let timeText = '';
                if (frequencyText === 'Weekly') {
                    const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    frequencyText += ` on ${dayMap[this.currentMedication.weekDay]}`;
                    timeText = `at ${this.currentMedication.time}`;
                } else if (frequencyText === 'Twice Daily') {
                    timeText = `at ${this.currentMedication.times[0]} and ${this.currentMedication.times[1]}`;
                } else {
                    timeText = `at ${this.currentMedication.time}`;
                }
                this.addMessage(`Great! I’ve added ${this.currentMedication.name} to your list. You’ll take it ${frequencyText} ${timeText}. Notifications: ${this.currentMedication.notify ? 'On' : 'Off'}.`);
            }

            this.currentMedication = null;
            this.currentStep = null;
            this.currentTimeIndex = 0;

            this.showOptions([
                'Add Another Medication',
                'View Medications',
                'Back to Main Menu'
            ]);
        }

        addMedication(medication) {
            this._storage.medications.push(medication);
            this.saveMedications();
        }

        getMedications() {
            return this._storage.medications;
        }

        async viewMedications() {
            const medications = this.getMedications();
            if (medications.length === 0) {
                this.addMessage('You haven’t added any medications yet. Let’s add one! 😊');
                this.showOptions(['Add Medication', 'Back to Main Menu']);
                return;
            }

            this.addMessage('Here are your medications with detailed info...');

            const drugInfoPromises = medications.map(med => 
                new Promise((resolve) => {
                    this.fetchDrugInformationForView(med.name, (drugInfo) => {
                        resolve({ medication: med, drugInfo });
                    });
                })
            );

            try {
                const results = await Promise.all(drugInfoPromises);
                let medicationList = '<strong>Your Medications:</strong><br><br>';

                results.forEach(({ medication, drugInfo }, index) => {
                    let frequencyText = medication.frequency;
                    let timeText = '';
                    if (medication.frequency === 'Weekly') {
                        const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                        frequencyText += ` on ${dayMap[medication.weekDay]}`;
                        timeText = `at ${medication.time || 'No time set'}`;
                    } else if (medication.frequency === 'Twice Daily') {
                        timeText = `at ${medication.times[0]} and ${medication.times[1]}`;
                    } else {
                        timeText = `at ${medication.time || 'No time set'}`;
                    }

                    medicationList += `
                        <div class="api-result">
                            <strong><span class="bold-number">${index + 1}.</span> ${medication.name}</strong><br>
                            <strong>Schedule:</strong> ${frequencyText} ${timeText}<br>
                            <strong>Notifications:</strong> ${medication.notify ? 'On' : 'Off'}<br><br>
                    `;

                    if (drugInfo) {
                        if (drugInfo.brandName) {
                            medicationList += `<strong>Brand Name:</strong> ${drugInfo.brandName}<br>`;
                        }
                        if (drugInfo.genericName) {
                            medicationList += `<strong>Generic Name:</strong> ${drugInfo.genericName}<br>`;
                        }
                        medicationList += `<strong>Purpose:</strong> ${drugInfo.purpose}<br><br>`;
                        medicationList += `<strong>Uses:</strong><ul>${drugInfo.uses.map(use => `<li>${use}</li>`).join('')}</ul><br>`;
                        medicationList += `<strong>Warnings:</strong><ul>${drugInfo.warnings.map(warning => `<li>${warning}</li>`).join('')}</ul>`;
                        if (drugInfo.source) {
                            medicationList += `<br><small>Data provided by ${drugInfo.source}.</small>`;
                        }
                    } else {
                        medicationList += 'Detailed information not available.<br>';
                    }
                    medicationList += '</div><br>';
                });

                this.addMessage(medicationList);
            } catch (error) {
                this.addMessage('Oops! There was an error fetching detailed info. Let’s try again later.');
            }

            this.showOptions([
                'Add Medication',
                'Edit Medication',
                'Delete Medication',
                'Back to Main Menu'
            ]);
        }

        async viewMedicationsForEdit() {
            const medications = this.getMedications();
            if (medications.length === 0) {
                this.addMessage('No medications to edit yet. Add one first!');
                this.showOptions(['Add Medication', 'Back to Main Menu']);
                return;
            }

            let medicationList = '<strong>Your Medications (Select one to edit):</strong><br><br>';
            medications.forEach((medication, index) => {
                let frequencyText = medication.frequency;
                let timeText = '';
                if (medication.frequency === 'Weekly') {
                    const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    frequencyText += ` on ${dayMap[medication.weekDay]}`;
                    timeText = `at ${medication.time || 'No time set'}`;
                } else if (medication.frequency === 'Twice Daily') {
                    timeText = `at ${medication.times[0]} and ${medication.times[1]}`;
                } else {
                    timeText = `at ${medication.time || 'No time set'}`;
                }
                medicationList += `<span class="bold-number">${index + 1}.</span> ${medication.name} - ${frequencyText} ${timeText}<br>`;
            });
            this.addMessage(medicationList);
        }

        async viewMedicationsForDelete() {
            const medications = this.getMedications();
            if (medications.length === 0) {
                this.addMessage('No medications to delete yet. Add one first!');
                this.showOptions(['Add Medication', 'Back to Main Menu']);
                return;
            }

            let medicationList = '<strong>Your Medications (Select one to delete):</strong><br><br>';
            medications.forEach((medication, index) => {
                let frequencyText = medication.frequency;
                let timeText = '';
                if (medication.frequency === 'Weekly') {
                    const dayMap = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    frequencyText += ` on ${dayMap[medication.weekDay]}`;
                    timeText = `at ${medication.time || 'No time set'}`;
                } else if (medication.frequency === 'Twice Daily') {
                    timeText = `at ${medication.times[0]} and ${medication.times[1]}`;
                } else {
                    timeText = `at ${medication.time || 'No time set'}`;
                }
                medicationList += `<span class="bold-number">${index + 1}.</span> ${medication.name} - ${frequencyText} ${timeText}<br>`;
            });
            this.addMessage(medicationList);
        }

        startEditMedicationFlow(indexStr) {
            const index = parseInt(indexStr) - 1;
            if (isNaN(index) || index < 0 || index >= this._storage.medications.length) {
                this.addMessage('Invalid medication number. Please enter a number from the list.');
                this.viewMedicationsForEdit();
                this.addMessage('Enter the number of the medication to edit (e.g., 1):');
                return;
            }

            this.editingIndex = index;
            this.currentMedication = { ...this._storage.medications[index] };
            this.addMessage(`Editing ${this.currentMedication.name}. Enter a new name (or press Enter to keep "${this.currentMedication.name}"):`);
            this.currentStep = 'editMedicationName';
        }

        handleEditMedicationName(name) {
            if (name) {
                this.currentMedication.name = name;
                if ((name.toLowerCase() === 'aspirin' && this._storage.medications.some(m => m.name.toLowerCase() === 'ibuprofen' && m !== this._storage.medications[this.editingIndex])) ||
                    (name.toLowerCase() === 'ibuprofen' && this._storage.medications.some(m => m.name.toLowerCase() === 'aspirin' && m !== this._storage.medications[this.editingIndex]))) {
                    this.addMessage('⚠️ Warning: Combining Aspirin and Ibuprofen may increase bleeding risk. Consult your doctor.');
                }
            }
            this.addMessage('How often do you want to take this medication?');
            this.showOptions(['Once Daily', 'Twice Daily', 'Weekly']);
            this.currentStep = 'editMedicationFrequency';
        }

        handleEditMedicationTime(time) {
            const timeRegex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            if (!timeRegex.test(time)) {
                this.addMessage('Please enter a valid time in HH:MM format (e.g., 14:30).');
                return;
            }

            if (this.currentMedication.frequency === 'Twice Daily') {
                this.currentMedication.times = this.currentMedication.times || [];
                this.currentMedication.times.push(time);

                if (this.currentTimeIndex === 0) {
                    this.currentTimeIndex++;
                    this.addMessage('At what time do you want to take this in the evening? (HH:MM format)');
                    return;
                }
            } else {
                this.currentMedication.time = time;
            }

            this.addMessage('Would you like notifications for this medication?');
            this.showOptions(['Yes', 'No']);
            this.currentStep = 'editMedicationNotify';
        }

        handleEditMedicationNotify(choice) {
            this.handleMedicationNotify(choice);
        }

        deleteMedication(index) {
            if (isNaN(index) || index < 0 || index >= this._storage.medications.length) {
                this.addMessage('Invalid medication number. Please enter a number from the list.');
                this.viewMedicationsForDelete();
                this.addMessage('Enter the number of the medication to delete (e.g., 1):');
                return;
            }

            const removedMed = this._storage.medications.splice(index, 1)[0];
            this.saveMedications();
            this.addMessage(`Successfully deleted ${removedMed.name} from your medications!`);
            this.currentStep = null;
            this.showOptions(['Delete Medication', 'Back to Main Menu']);
        }

        fetchDrugInformationForView(drugName, callback) {
            this.fetchDrugInformation(drugName, callback, true);
        }

        async fetchDrugInformation(drugName, callback, isForView = false) {
            if (!isForView) this.addMessage(`Fetching information for "${drugName}"...`);
            
            const normalizedName = drugName.toLowerCase();
            if (this._storage.drugCache[normalizedName]) {
                const cachedInfo = this._storage.drugCache[normalizedName];
                if (isForView) callback(cachedInfo);
                else this.displayDrugInfo(drugName, [cachedInfo]);
                return;
            }
            
            if (this.drugDatabase[normalizedName]) {
                const localDrugInfo = this.drugDatabase[normalizedName];
                this._storage.drugCache[normalizedName] = localDrugInfo;
                if (isForView) callback(localDrugInfo);
                else this.displayDrugInfo(drugName, [localDrugInfo]);
                if (!isForView) this.currentStep = null;
                return;
            }

            try {
                const fdaUrl = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:${encodeURIComponent(drugName)}+OR+openfda.generic_name:${encodeURIComponent(drugName)}&limit=10`;
                const fdaResponse = await fetch(fdaUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!fdaResponse.ok) {
                    if (fdaResponse.status === 429) throw new Error('Rate limit exceeded');
                    throw new Error(`OpenFDA error: ${fdaResponse.status}`);
                }

                const fdaData = await fdaResponse.json();

                if (fdaData.results && fdaData.results.length > 0) {
                    const drugInfos = fdaData.results.map(result => this.processOpenFdaResponse(result, drugName));
                    drugInfos.forEach(info => this._storage.drugCache[normalizedName] = info);
                    if (isForView) callback(drugInfos[0]);
                    else this.displayDrugInfo(drugName, drugInfos);
                    if (!isForView) this.currentStep = null;
                    return;
                }
            } catch (error) {
                if (!isForView) {
                    this.addMessage(`OpenFDA failed: ${error.message}. Trying another source...`);
                }
            }

            try {
                const rxnormUrl = `https://rxnav.nlm.nih.gov/REST/drugs.json?name=${encodeURIComponent(drugName)}`;
                const rxnormResponse = await fetch(rxnormUrl, {
                    headers: { 'User-Agent': 'MediChat/1.0' }
                });

                if (!rxnormResponse.ok) throw new Error(`RxNorm error: ${rxnormResponse.status}`);
                const rxnormData = await rxnormResponse.json();

                if (rxnormData.drugGroup && rxnormData.drugGroup.conceptGroup?.length > 0) {
                    const drugInfos = this.processRxNormResponse(rxnormData, drugName);
                    drugInfos.forEach(info => this._storage.drugCache[normalizedName] = info);
                    if (isForView) callback(drugInfos[0]);
                    else this.displayDrugInfo(drugName, drugInfos);
                } else {
                    if (isForView) callback(null);
                    else {
                        this.addMessage(`No detailed information found for "${drugName}".`);
                        this.showOptions(['Check Another Drug', 'Back to Main Menu']);
                    }
                }
            } catch (error) {
                if (isForView) {
                    callback(null);
                } else {
                    let errorMessage = `Failed to fetch info for "${drugName}": ${error.message}.`;
                    if (error.message.includes('Rate limit')) {
                        errorMessage = `Rate limit exceeded. Please try again later.`;
                    }
                    this.addMessage(errorMessage);
                    this.showOptions(['Check Another Drug', 'Back to Main Menu']);
                }
            }

            if (!isForView) this.currentStep = null;
        }

        processOpenFdaResponse(result, drugName) {
            const drugInfo = {
                purpose: 'Not available',
                uses: ['Consult your healthcare provider for usage information'],
                warnings: ['Follow doctor\'s instructions', 'Consult a healthcare professional'],
                source: 'OpenFDA'
            };
            
            if (result.purpose?.[0]) {
                drugInfo.purpose = result.purpose[0];
            } else if (result.indications_and_usage?.[0]) {
                drugInfo.purpose = result.indications_and_usage[0];
            }
            
            if (result.indications_and_usage?.[0]) {
                drugInfo.uses = this.formatApiText(result.indications_and_usage[0]);
            }
            
            if (result.warnings?.[0]) {
                drugInfo.warnings = this.formatApiText(result.warnings[0]);
            } else if (result.warnings_and_precautions?.[0]) {
                drugInfo.warnings = this.formatApiText(result.warnings_and_precautions[0]);
            }
            
            if (result.openfda) {
                drugInfo.brandName = result.openfda.brand_name?.[0];
                drugInfo.genericName = result.openfda.generic_name?.[0];
            }
            
            return drugInfo;
        }

        processRxNormResponse(data, drugName) {
            const drugInfos = [];
            const conceptGroups = data.drugGroup.conceptGroup || [];
            const drugConcepts = conceptGroups
                .filter(group => group.conceptProperties)
                .flatMap(group => group.conceptProperties)
                .slice(0, 10);

            if (drugConcepts.length === 0) {
                return [{
                    purpose: 'Medication for therapeutic use',
                    uses: ['Consult your healthcare provider for specific uses'],
                    warnings: ['Follow doctor\'s instructions', 'Consult a healthcare professional'],
                    source: 'RxNorm'
                }];
            }

            drugConcepts.forEach(concept => {
                const drugInfo = {
                    purpose: 'Medication for therapeutic use',
                    uses: ['Consult your healthcare provider for specific uses'],
                    warnings: ['Follow doctor\'s instructions', 'Consult a healthcare professional'],
                    brandName: concept.synonym || drugName,
                    genericName: concept.name || drugName,
                    source: 'RxNorm'
                };
                drugInfos.push(drugInfo);
            });

            return drugInfos;
        }

        formatApiText(text) {
            if (!text) return ['Information not available'];
            const lines = text.split(/[.•\n]/).map(line => line.trim()).filter(line => line.length > 0);
            return lines.length > 0 ? lines.slice(0, 5).map(line => line + '.') : [text];
        }

        displayDrugInfo(drugName, drugInfos) {
            if (!drugInfos || drugInfos.length === 0) {
                this.addMessage(`No information found for "${drugName}".`);
                this.showOptions(['Check Another Drug', 'Back to Main Menu']);
                return;
            }

            let infoHTML = `<div class="api-result"><strong>Drug Information for "${drugName}"</strong><br><br>`;
            
            drugInfos.forEach((drugInfo, index) => {
                infoHTML += `<strong>Result ${index + 1}:</strong><br>`;
                if (drugInfo.brandName) {
                    infoHTML += `<strong>Brand Name:</strong> ${drugInfo.brandName}<br>`;
                }
                if (drugInfo.genericName) {
                    infoHTML += `<strong>Generic Name:</strong> ${drugInfo.genericName}<br>`;
                }
                infoHTML += `<strong>Purpose:</strong> ${drugInfo.purpose}<br><br>`;
                infoHTML += `<strong>Uses:</strong><ul>${drugInfo.uses.map(use => `<li>${use}</li>`).join('')}</ul><br>`;
                infoHTML += `<strong>Warnings:</strong><ul>${drugInfo.warnings.map(warning => `<li>${warning}</li>`).join('')}</ul>`;
                if (drugInfo.source) {
                    infoHTML += `<br><small>Data provided by ${drugInfo.source}.</small>`;
                }
                infoHTML += '<br><br>';
            });
            
            infoHTML += `</div>`;
            this.addMessage(infoHTML);
            this.showOptions(['Check Another Drug', 'Back to Main Menu']);
        }
    }

    const mediChat = new MediChatAssistant();
    </script>
</body>
</html>